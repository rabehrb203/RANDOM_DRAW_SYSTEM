<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div id="loginSection" class="section">
      <h1>Admin Login</h1>
      <div class="login-form">
        <label for="adminUsername">Username:</label>
        <input type="text" id="adminUsername" placeholder="Enter username" />
        <label for="adminPassword">Password:</label>
        <input
          type="password"
          id="adminPassword"
          placeholder="Enter password"
        />
        <button onclick="adminLogin()">Login</button>
      </div>
    </div>

    <div id="dashboardSection" class="section" style="display: none">
      <h1>Random Draw System - Dashboard</h1>

      <div class="admin-section">
        <div
          style="
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin: 0px 16px;
          "
        >
          <h2>Prize Statistics</h2>
          <button onclick="deleteWinners()">Clear</button>
        </div>

        <div class="stats-container">
          <div class="stat-card">
            <div class="stat-number" id="prize20Count">0</div>
            <div class="stat-label">20 BD Prize / 1000</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="prize30Count">0</div>
            <div class="stat-label">30 BD Prize / 60</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="prize40Count">0</div>
            <div class="stat-label">40 BD Prize / 40</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalParticipants">0</div>
            <div class="stat-label">Total Participants</div>
          </div>
        </div>
      </div>

      <div class="admin-section">
        <div
          style="
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
            margin: 0px 16px;
          "
        >
          <h2>Winners List</h2>

          <div class="download-section">
            <button class="download-btn" onclick="downloadExcel()">
              <svg
                width="28px"
                height="28px"
                viewBox="-4 0 64 64"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M5.112.006c-2.802 0-5.073 2.273-5.073 5.074v53.841c0 2.803 2.271 5.074 5.073 5.074h45.774c2.801 0 5.074-2.271 5.074-5.074v-38.605l-18.902-20.31h-31.946z"
                  fill-rule="evenodd"
                  clip-rule="evenodd"
                  fill="#45B058"
                />
                <path
                  d="M19.429 53.938c-.216 0-.415-.09-.54-.27l-3.728-4.97-3.745 4.97c-.126.18-.324.27-.54.27-.396 0-.72-.306-.72-.72 0-.144.035-.306.144-.432l3.89-5.131-3.619-4.826c-.09-.126-.145-.27-.145-.414 0-.342.288-.72.721-.72.216 0 .432.108.576.288l3.438 4.628 3.438-4.646c.127-.18.324-.27.541-.27.378 0 .738.306.738.72 0 .144-.036.288-.127.414l-3.619 4.808 3.891 5.149c.09.126.125.27.125.414 0 .396-.324.738-.719.738zm9.989-.126h-5.455c-.595 0-1.081-.486-1.081-1.08v-10.317c0-.396.324-.72.774-.72.396 0 .721.324.721.72v10.065h5.041c.359 0 .648.288.648.648 0 .396-.289.684-.648.684zm6.982.216c-1.782 0-3.188-.594-4.213-1.495-.162-.144-.234-.342-.234-.54 0-.36.27-.756.702-.756.144 0 .306.036.433.144.828.738 1.98 1.314 3.367 1.314 2.143 0 2.826-1.152 2.826-2.071 0-3.097-7.111-1.386-7.111-5.672 0-1.98 1.764-3.331 4.123-3.331 1.548 0 2.881.468 3.853 1.278.162.144.253.342.253.54 0 .36-.307.72-.703.72-.145 0-.307-.054-.432-.162-.883-.72-1.98-1.044-3.079-1.044-1.44 0-2.467.774-2.467 1.909 0 2.701 7.112 1.152 7.112 5.636 0 1.748-1.188 3.53-4.43 3.53z"
                  fill="#ffffff"
                />
                <path
                  d="M55.953 20.352v1h-12.801s-6.312-1.26-6.127-6.707c0 0 .207 5.707 6.002 5.707h12.926z"
                  fill-rule="evenodd"
                  clip-rule="evenodd"
                  fill="#349C42"
                />
                <path
                  d="M37.049 0v14.561c0 1.656 1.104 5.791 6.104 5.791h12.801l-18.905-20.352z"
                  opacity=".5"
                  fill-rule="evenodd"
                  clip-rule="evenodd"
                  fill="#ffffff"
                />
              </svg>
            </button>
            <button class="download-btn" onclick="downloadJS()">
              <svg
                width="28px"
                height="28px"
                viewBox="0 0 32 32"
                xmlns="http://www.w3.org/2000/svg"
              >
                <title>file_type_js</title>
                <path
                  d="M18.774,19.7a3.727,3.727,0,0,0,3.376,2.078c1.418,0,2.324-.709,2.324-1.688,0-1.173-.931-1.589-2.491-2.272l-.856-.367c-2.469-1.052-4.11-2.37-4.11-5.156,0-2.567,1.956-4.52,5.012-4.52A5.058,5.058,0,0,1,26.9,10.52l-2.665,1.711a2.327,2.327,0,0,0-2.2-1.467,1.489,1.489,0,0,0-1.638,1.467c0,1.027.636,1.442,2.1,2.078l.856.366c2.908,1.247,4.549,2.518,4.549,5.376,0,3.081-2.42,4.769-5.671,4.769a6.575,6.575,0,0,1-6.236-3.5ZM6.686,20c.538.954,1.027,1.76,2.2,1.76,1.124,0,1.834-.44,1.834-2.15V7.975h3.422V19.658c0,3.543-2.078,5.156-5.11,5.156A5.312,5.312,0,0,1,3.9,21.688Z"
                  style="fill: #f5de19"
                />
              </svg>
            </button>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>ID Number</th>
              <th>Prize Amount</th>
              <th>Draw Date</th>
            </tr>
          </thead>
          <tbody id="membersTable"></tbody>
        </table>
      </div>
    </div>

    <div class="navigation">
      <a href="/">View Public Page</a>
    </div>

    <script>
      let authHeader = "";

      function adminLogin() {
        const username = document.getElementById("adminUsername").value;
        const password = document.getElementById("adminPassword").value;

        if (username === "admin" && password === "admin123") {
          authHeader = `Basic ${btoa(username + ":" + password)}`;
          document.getElementById("loginSection").style.display = "none";
          document.getElementById("dashboardSection").style.display = "flex";
          loadDashboardData();
        } else {
          alert("Invalid login credentials");
        }
      }

      function loadDashboardData() {
        fetch("/winners")
          .then((res) => res.json())
          .then((data) => {
            updateStatistics(data);
            updateWinnersTable(data);
          })
          .catch((err) => console.error(err));
      }

      async function deleteWinners() {
        if (!confirm("Are you sure you want to delete all winners?")) return;

        const response = await fetch("/winners", {
          method: "DELETE",
          headers: { Authorization: "Basic " + btoa("admin:admin123") },
        });
        const result = await response.json();

        alert(result.message || "An error occurred while deleting");
        location.reload();
      }

      function updateStatistics(data) {
        const prize20 = data.filter((m) => m.prize === 20).length;
        const prize30 = data.filter((m) => m.prize === 30).length;
        const prize40 = data.filter((m) => m.prize === 40).length;

        document.getElementById("prize20Count").textContent = prize20;
        document.getElementById("prize30Count").textContent = prize30;
        document.getElementById("prize40Count").textContent = prize40;
        document.getElementById("totalParticipants").textContent = data.length;
      }

      function updateWinnersTable(data) {
        const table = document.getElementById("membersTable");
        table.innerHTML = "";

        data.forEach((member) => {
          const row = `<tr>
                      <td>${member.name}</td>
                      <td>${member.phone}</td>
                      <td>${member.prize} BD</td>
                      <td>${new Date(member.drawDate).toLocaleDateString()}</td>
                  </tr>`;
          table.innerHTML += row;
        });
      }

      function downloadExcel() {
        fetch("/export/excel", {
          headers: {
            Authorization: authHeader,
          },
        })
          .then((response) => {
            if (!response.ok) {
              if (response.status === 401) {
                throw new Error("Authentication required");
              }
              throw new Error(`Server error: ${response.status}`);
            }
            return response.blob();
          })
          .then((blob) => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.style.display = "none";
            a.href = url;
            a.download = "members.xlsx";
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
          })
          .catch((err) => {
            console.error("Error downloading Excel:", err);
            if (err.message === "Authentication required") {
              alert("Please log in again");
              document.getElementById("dashboardSection").style.display =
                "none";
              document.getElementById("loginSection").style.display = "flex";
            } else {
              alert(`Error downloading Excel file: ${err.message}`);
            }
          });
      }

      function downloadJS() {
        fetch("/export/json", {
          headers: {
            Authorization: authHeader,
          },
        })
          .then((response) => {
            if (!response.ok) {
              if (response.status === 401) {
                throw new Error("Authentication required");
              }
              throw new Error(`Server error: ${response.status}`);
            }
            return response.text();
          })
          .then((text) => {
            const blob = new Blob([text], { type: "application/javascript" });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.style.display = "none";
            a.href = url;
            a.download = "member.js";
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
          })
          .catch((err) => {
            console.error("Error downloading JS file:", err);
            if (err.message === "Authentication required") {
              alert("Please log in again");
              document.getElementById("dashboardSection").style.display =
                "none";
              document.getElementById("loginSection").style.display = "flex";
            } else {
              alert(`Error downloading member.js file: ${err.message}`);
            }
          });
      }

      setInterval(loadDashboardData, 60000);
    </script>
  </body>
</html>
